---
# CloudWatch Agent setup for collecting cluster + workload metrics/logs.
# Update the ConfigMap (cwagentconfig.json) with your AWS Region and desired
# CloudWatch log group names before applying.

apiVersion: v1
kind: Namespace
metadata:
  name: amazon-cloudwatch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cloudwatch-agent
  namespace: amazon-cloudwatch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloudwatch-agent-role
rules:
  - apiGroups:
      - ""
    resources:
      - pods
      - nodes
      - endpoints
      - services
      - events
    verbs:
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - namespaces
      - configmaps
    verbs:
      - list
      - get
  - apiGroups:
      - apps
      - extensions
    resources:
      - replicasets
    verbs:
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloudwatch-agent-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cloudwatch-agent-role
subjects:
  - kind: ServiceAccount
    name: cloudwatch-agent
    namespace: amazon-cloudwatch
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cwagentconfig
  namespace: amazon-cloudwatch
  labels:
    app: cloudwatch-agent
data:
  cwagentconfig.json: |
    {
      "agent": {
        "metrics_collection_interval": 60,
        "region": "us-east-1"
      },
      "logs": {
        "logs_collected": {
          "kubernetes": {
            "cluster_name": "drcio-demo",
            "log_group_name": "/aws/eks/drcio-demo/workloads",
            "log_stream_name": "{namespace_name}/{pod_name}",
            "retention_in_days": 7
          }
        }
      },
      "metrics": {
        "metrics_collected": {
          "kubernetes": {
            "cluster_name": "drcio-demo",
            "metrics_collection_interval": 60,
            "resource_fields": [
              {"name": "pod_cpu_utilization"},
              {"name": "pod_memory_working_set"},
              {"name": "node_cpu_utilization"},
              {"name": "node_memory_working_set"},
              {"name": "pod_network_rx_bytes"},
              {"name": "pod_network_tx_bytes"},
              {"name": "pod_fs_usage_bytes"}
            ],
            "enhanced_container_insights": true
          }
        }
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cloudwatch-agent
  namespace: amazon-cloudwatch
  labels:
    app: cloudwatch-agent
spec:
  selector:
    matchLabels:
      app: cloudwatch-agent
  template:
    metadata:
      labels:
        app: cloudwatch-agent
    spec:
      serviceAccountName: cloudwatch-agent
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: cloudwatch-agent
          image: public.ecr.aws/cloudwatch-agent/cloudwatch-agent:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 250m
              memory: 400Mi
          env:
            - name: HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: HOST_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: cwagentconfig
              mountPath: /etc/cwagentconfig
            - name: rootfs
              mountPath: /rootfs
              readOnly: true
            - name: varlog
              mountPath: /var/log
            - name: dockercontainerlog
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: dockersock
              mountPath: /var/run/docker.sock
              readOnly: true
            - name: containerdsock
              mountPath: /run/containerd/containerd.sock
              readOnly: true
      volumes:
        - name: cwagentconfig
          configMap:
            name: cwagentconfig
        - name: rootfs
          hostPath:
            path: /
        - name: varlog
          hostPath:
            path: /var/log
        - name: dockercontainerlog
          hostPath:
            path: /var/lib/docker/containers
        - name: dockersock
          hostPath:
            path: /var/run/docker.sock
        - name: containerdsock
          hostPath:
            path: /run/containerd/containerd.sock
